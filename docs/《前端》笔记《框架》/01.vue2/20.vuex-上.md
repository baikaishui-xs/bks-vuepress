---
title: vuex（上）
date: 2022-06-27 11:01:39
permalink: /pages/65ee94/
categories:
  - 《前端》笔记《框架》
  - 1.vue2
tags:
  - 
---
**作用：** 大范围数据、方法共享

**下载：** npm install vuex --save

**优点：**
  1、能够在 vuex 中集中管理共享的数据，易于开发和后期维护
  2、能够高效地实现组件之间的数据共享，提高开发效率
  3、存储在 vuex 中的数据都是响应式的，能够实时保持数据与页面的同步

**特性：** 页面刷新时，数据会丢失

## 配置（以下三个步骤，vue-cli 会自动配置）
  ### 1、导入 vuex 包（-- store.js）
  ```js
  import Vuex from 'vuex'
  Vue.use(Vuex)
  ```

  ### 2、创建 store 对象（-- 同上）
  ```js
  const store = new Vuex.Store({
    // state：存放全局共享的数据
    state: { count: 0 }
  })
  ```

  ### 3、将 store 对象挂载到 vue 实例中（-- 同上）
  ```js
  new Vue({
    // 将创建的共享数据对象，挂载到 Vue 实例中
    // 所有的组件，就可以直接从 store 中获取全局的数据了
    store
  })
  ```

## 开启命名空间
  **语法：** `namespaced: true`

  **作用：** 防止全局污染，让模块独立

  **特性：** 使用 vuex 仓库中的数据时，除 state 以外的数据都需要带上模块名


## 配置项

### State 配置项
  **作用：** 存储全局数据

  #### 创建
  ##### 1、定义数据
  ```js
  const state = {
    token: ''
  }
  ```

  #### 使用
  ##### （一）映射到计算属性中
  ###### 1、按需导入
  ```js
  import { mapState } from 'vuex' 
  ```

  ###### 2、映射到计算属性中
  ```js
  ...mapState(['user/token'])  
  ```

  ###### 3、使用
  ```html
  <div>{{token}}</div>
  ```

  ##### （二）this.$store.state（推荐：因为少了导入这一步）
  **语法：** this.$store.state.模块名.state 数据

  ###### 1、使用
  ```html
  <div>{{$store.state.user.token}}</div>
  ```

### Mutation 配置项
  **作用：** 修改 store 中的数据

  #### 创建
  ```js
  const mutations = {
    // 参数一：state 配置项
    // 参数二：设置 state 数据的值
    setToken(state, token) {
      state.toke = token
    }
  }
  ```

  #### 使用
  ##### （一）映射到 methods 中
  ###### 1、按需导入
  ```js
  import { mapMutations } from 'vuex'
  ```

  ###### 2、映射到 methods 中
  ```js
  ...mapMutations(['user/login']),
  ```

  ###### 3、放到一个方法中
  ```js
  methods() {
    login() {
      this['user/login']()
    }
  }
  ```

  ###### 4、使用
  ```html
  <button @click="login"></button>
  ```

  ##### （二）this.$store.commit()（推荐：因为少了导入这一步）
  **参数一：** 模块名/Mutation 方法名
  **参数二：** 设置 state 数据的值

  ###### 1、使用
  ```html
  <button @click="setToken"></button>
  ```

### Actions 配置项
  **作用：** 处理异步任务

  #### 创建
  ```js
  const actions = {
    // 参数一：调用 Mutation 配置项中的方法
    async login(context, data) {
      const token = await login(data)

      // 参数一：Mutation 配置项中的方法
      // 参数二：设置 state 数据的值
      context.commit('setToken', token)
    }
  }
  ```

  #### 使用
  ##### （一）映射到 methods 中
  ###### 1、按需导入
  ```js
  import { mapActions } from 'vuex'
  ```

  ###### 2、映射到 methods 中
  ```js
  ...mapActions(['user/login'])
  ```

  ###### 3、放到方法中
  ```js
  methods() {
    login() {
      this['user/login']()
    }
  }
  ```

  ###### 4、使用
  ```html
  <button @click="login"></button>
  ```

  ##### （二）this.$store.dispatch()（推荐：因为少了导入这一步）
  **参数一：** '模块名/要触发的 Action'
  **参数二：** 设置 state 数据的值

  ###### 1、使用
  ```js
  this.$store.dispatch('user/login', data)
  ```

### Getter 配置项
  **作用：** 监听 State 配置项中数据的变化

  #### 创建
  ```js
  const getters = {
    newToken: state => {
      return state.token + 'demo'
    }
  }
  ```

  #### 使用
  ##### （一）映射到计算属性中
  ###### 1、按需导入
  ```js
  import { mapGetters } from 'vuex'
  ```

  ###### 2、映射到计算属性中
  ```js
  ...mapGetters(['user/newToken'])
  ```

  ###### 3、使用
  ```html
  <div>{{newToken}}</div>
  ```

  ##### （二）this.$store.getters（推荐：因为少了导入这一步）
  ###### 1、使用
  **语法：** this.$store.getters.模块名.getters 数据

  ```html
  <div>{{$store.getters.user.newToken}}</div>
  ```

```
## 在组合式 API 中使用 vuex

  创建（-- store/index.js）
    import { createStore } from 'vuex'

    export default createStore({  // 创建仓库
      state: {
        username: 'zs'
      },
      getters: {
        newname (state) {
          return state.username + '!!!'
        }
      },
      mutations: {
        updateName (state) {
          state.username = 'ls'
        }
      },
      actions: {
        updateName (ctx) {
          setTimeout(()=>{
            ctx.commit('updateName')
          }, 1000)
        }
      },
      modules: {}
    })

  使用（-- 组件）
    // 从 vuex 中按需导入仓库实例
    import { useStore } from 'vuex'

    setup () {

      // 获取 vuex 仓库实例
      const store = useStore()

      // 使用 state 中的数据
      store.state.count

      // 使用 getters 中的数据
      store.getters.count

      // 使用 mutations 中的方法
      const mutationsFn = () => {
        store.commit('updatename')

        // 使用 actions 中的方法
        store.dispatch('updatename')
      }
      return { mutationsFn }
      <button @cilck='mutationsFn'>mutationsFn</button>  // 绑定方法
      
    }

例子：计数器

  -- store.js

    import Vue from 'vue'
    import Vuex from 'vuex'

    Vue.use(Vuex)

    export default new Vuex.Store({
      state: {
        count: 0
      },
      mutations: {
        add(state) {
          // 不要在 mutations 函数中，执行异步操作，这样会导致 state 中的全局数据不同步（可在 vuex 调试栏中查看）
          // 解决方法：使用 Action 配置项
          // setTimeout(() => {
          //   state.count++
          // }, 1000)
          state.count++
        },
        addN(state, step) {
          state.count += step
        },
        sub(state) {
          state.count--
        },
        subN(state, step) {
          state.count -= step
        }
      },
      actions: {
        addAsync(context) {
          setTimeout(() => {
            // 在 actions 中，不能直接修改 state 中的数据；
            // 必须通过 context.commit() 触发某个 mutation 才行
            context.commit('add')
          }, 1000)
        },
        addNAsync(context, step) {
          setTimeout(() => {
            context.commit('addN', step)
          }, 1000)
        },
        subAsync(context) {
          setTimeout(() => {
            context.commit('sub')
          }, 1000)
        },
        subNAsync(context, step) {
          setTimeout(() => {
            context.commit('subN', step)
          }, 1000)
        }
      },
      getters: {
        showNum(state) {
          return '当前最新的数量是【' + state.count + '】'
        }
      }
    })

  -- App.vue

    <template>
      <div>
        <my-addition></my-addition>

        <p>---------------------------------</p>

        <my-subtraction></my-subtraction>
      </div>
    </template>

    <script>
      import Addition from './components/Addition.vue'
      import Subtraction from './components/Subtraction.vue'

      export default {
        data() {
          return {}
        },
        components: {
          'my-addition': Addition,
          'my-subtraction': Subtraction
        }
      }
    </script>
  
  -- Addition.vue

    <template>
      <div>
        <!-- <h3>当前最新的count值为：{{$store.state.count}}</h3> -->
        <h3>{{$store.getters.showNum}}</h3>
        <button @click="btnHandler1">+1</button>
        <button @click="btnHandler2">+N</button>
        <button @click="btnHandler3">+1 Async</button>
        <button @click="btnHandler4">+N Async</button>
      </div>
    </template>

    <script>
      export default {
        data() {
          return {}
        },
        methods: {
          btnHandler1() {
              // 错误写法（不推荐直接修改全局数据）：this.$store.state.count++
              // 正确写法（使用 Mutation 配置项）
              this.$store.commit('add')
          },
          btnHandler2() {
            // commit 的作用，就是调用 某个 mutation 函数
            this.$store.commit('addN', 3)
          },
          // 异步地让 count 自增 +1
          btnHandler3() {
            // 这里的 dispatch 函数，专门用来触发 action
            this.$store.dispatch('addAsync')
          },
          btnHandler4() {
            this.$store.dispatch('addNAsync', 5)
          }
        }
      }
    </script>

  -- Subtracition.vue

    <template>
      <div>
        <!-- <h3>当前最新的count值为：{{count}}</h3> -->
        <h3>{{showNum}}</h3>
        <button @click="btnHandler1">-1</button>
        <button @click="subN(3)">-N</button>
        <button @click="subAsync">-1 Async</button>
        <button @click="subNAsync(5)">-N Async</button>
      </div>
    </template>

  <script>
    import { mapState, mapMutations, mapActions, mapGetters } from 'vuex'

    export default {
      data() {
        return {}
      },
      computed: {
        ...mapState(['count']),
        ...mapGetters(['showNum'])
      },
      methods: {
        ...mapMutations(['sub', 'subN']),
        ...mapActions(['subAsync', 'subNAsync']),
        btnHandler1() {
          this.sub()
        }
      }
    }
  </script>
```