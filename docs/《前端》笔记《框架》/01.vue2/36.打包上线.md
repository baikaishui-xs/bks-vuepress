---
title: 打包上线
date: 2022-06-27 11:01:39
permalink: /pages/7482ad/
categories:
  - 《前端》笔记《框架》
  - 1.vue2
tags:
  - 
---
# 一、将路由模式改成 history 模式
## （一）hash 模式（默认）

## （二）history 模式
### 1、开启 history 模式
（-- @/router/index.js）
```js
const createRouter = () => new Router({

  -- 取消注释
  mode: 'history', // require service support
  --

  scrollBehavior: () => ({ y: 0 }),
  routes: [...constantRoutes, ...asyncRoutes],
})
```

# 二、设置前缀地址
  **设置前：** zhengzhengrishang.cc
  **设置后：** zhengzhengrishang.cc/hr

  （-- @/router/index.js）
  ```js
  const createRouter = () => new Router({
    mode: 'history', // require service support

    -- 增
    base: 'hr/', // 前缀地址
    --

    scrollBehavior: () => ({ y: 0 }),
    routes: constantRoutes
  })
  ```

### 2、配置前缀地址
```js
const createRouter = () => new Router({
  mode: 'history', // require service support

  -- 增
  base: 'hr/',
  --

  scrollBehavior: () => ({ y: 0 }),
  routes: [...constantRoutes, ...asyncRoutes],
})
```

### 3、查看地址栏的地址是否配置成功
**配置前：** `localhost:8888/#/attendances`

**配置后：** `localhost:8888/hr/attendances`

# 三、生成打包报告。打包报告会显示项目中错误语法等问题，然后针对这些问题进行优化
## （一）优化开发环境警告
vue-cli 视图界面中 → 运行 serve → 查看警告数 → 输出界面查看警告的信息，并进行优化

**常见警告：** 声明了变量，但没有使用

## （二）优化生产环境警告
vue-cli 视图界面中 → 运行 build → 查看警告数 → 输出界面查看警告的信息，并进行优化

**常见警告：**
（1）生产环境下不能有 console.log()、console.error()
**解决方法：** 使用插件，自动删除所有的 console.log()、console.error()
1、下载
`npm i babel-plugin-transform-remove-console@6.9.4 --save-dev`

2、在 plugins 数组中新增以下节点（-- babel.config.js）
```js
'plugins': [
  [
    'component',
    {...}
  ],

  -- 增
    'transform-remove-console'
  --
]
```

3、解决该插件 全环境 生效，影响开发环境的问题（-- babel.config.js）
**原理：** 判断当前环境，如果是生产环境下，自动将插件 push 到 plugins 中

```js
-- 增
  // 项目生产环境需要用到的 babel 插件
  const prodPlugins = []
  if (process.env.NODE_ENV === 'production') {
    prodPlugins.push('transform-remove-console')
  }
--

module.exports = {

  -- 改（'transform-remove-console' - ...prodPlugins）
    ...prodPlugins
  --

}
```

## （3）生成打包报告
### （3-1）vue-cli-service build --report

### （3-2）（推荐）：vue-cli 视图界面 → 运行 build → 查看速度统计、资源体积、依赖项体积
**提示：** 资源中带有警告图标的文件，表示体积过大，会影响性能
**使用步骤：** 在资源项中可以查看后面带 ！的文件，这些文件因为体积比较大，在页面发送请求时，会导致页面假死，需要进行体积优化。可以使用 CDN 服务器加载 解决

# 三、CDN 服务器加载。减小项目的体积，提高首屏页面的加载效率【！！！因为老师提供的 cdn 文件版本和当前项目的版本不一致，所以该步骤无法完成】
**作用：** 解决通过 import 语法导入的第三方依赖包，打包时会合并到同一个文件中，导致单文件体积过大的问题

## 1、查看体积过大的文件
vue-cli 图像界面 → 运行 build:prod 任务 → 查看依赖项。将体积超过 500 kb 或 功能性比较全的包，通过一下步骤进行 CDN 服务器加载

做完这一步截图一下图像界面，后面会做一个优化的前后对比

## 2、配置 externals
（-- vue.config.js）
```js
const port = process.env.port || process.env.npm_config_port || 9528 // dev port

-- 增
// 引入的 CDN 文件
let cdn = { css: [], js: [] }
let externals = {}
// 判断是否为生产环境
if (process.env.NODE_ENV === 'production') {
  externals = {
    // 格式：【key（排除的包）：value（CDN 文件中的全局变量名。用于导入 CDN 文件）】

    'element-ui': 'ELEMENT',
    'xlsx': 'XLSX',
    'vue': 'Vue',
  }
  cdn = {
    css: [
      // element-ui css
      'https://unpkg.com/element-ui/lib/theme-chalk/index.css' // 样式表
    ],
    js: [
      // vue must at first!
      'https://unpkg.com/vue/dist/vue.js', // vuejs
      // element-ui js
      'https://unpkg.com/element-ui/lib/index.js', // elementUI
      'https://cdn.jsdelivr.net/npm/xlsx@0.16.6/dist/jszip.min.js',
      'https://cdn.jsdelivr.net/npm/xlsx@0.16.6/dist/xlsx.full.min.js'
    ]
  }
}
--

// 配置 Webpack
configureWebpack: {
  ...

  -- 增
  // 排除包，并配置 CDN 文件中的全局变量名
  externals: externals
  --

}
```

## 3、注入 CDN 文件到 HTML 模板中
（-- 同上）
```js
-- 增
// 注入 cdn 变量。在执行打包时，会将 cdn 变量注入到 html 模板中
config.plugin('html').tap((args) => {
  // args：注入 html 模板的一个变量
  args[0].cdn = cdn
  return args
})
--

// when there are many pages, it will cause too many meaningless requests
config.plugins.delete('prefetch')
```

## 4、引入 css、js
（@/public/index.html）
```html
<head>
  ...

  -- 增
  <% for(var css of htmlWebpackPlugin.options.cdn.css) { %>
    <link rel="stylesheer" href="<%=css%>">
  <% } %>
  --

</head>
<body>
  ...

  -- 增
  <% for(var js of htmlWebpackPlugin.options.cdn.js) { %>
    <script src="<%=js%>"></script>
  <% } %>
  --

</body>
```

## 5、在生产环境下打包
图像界面运行任务 build:prod

## 6、打包后体积前后对比
**优化前：**
![](images/2022-04-19-09-07-38.png)

**优化后：**
![](images/2022-04-19-09-30-36.png) 